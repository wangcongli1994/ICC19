\section{Browser Behaviors on HTTPS Errors}
%There are many community standards for certificate validation,
%    for example,
%    RFC 5246, RFC 6125, and RFC 5280.
%    The certificate validation in browser
%    is more than a  literal replication of Internet standards protocols.
%    It needs to balance security, standards, and user experiences.
\subsection{Goal and Methodology}
We attempt to analyze the browser security warnings
    on various HTTPS errors.
We register a domain name and
    establish the website for it by Nginx.
We induce different HTTPS errors
    by
    (\emph{a}) invalid or defective certificate chains in TLS negotiations,
    (\emph{b}) mismatched public keys after HPKP pins the public keys in browsers,
    and (\emph{c}) HTTP connections after the HSTS policy is activated.
Then, the evaluated browsers visit  the website one by one,
    and we record the browser behaviors.
We utilize OpenSSL to generate key pairs and some certificates,
    while some server certificates are applied from Let's Encrypt.
TLS 1.2 is adopted in the HTTPS connections.

%we register a domain name and resolve many subdomains to our web server, and
%    each subdomain has a certificate that violate one of the certificate constraints.
%    We use browsers to visit these domains and observe the browsers' behavior.
%All connections to the web server is encrypted and authenticated using TLS 1.2.


%从域名商购得域名，并把该域名的所有子域名解析到我的服务器IP。根据实验安排首先生成一个自签名的根CA，安装根CA到系统和浏览器种，并使用该根CA对每一个实验的证书进行签名。对于每个证书：1.生成一个私钥 2.根据实验内容设置一个OpenSSL的配置文件 3.生成证书请求 4.使用OpenSSL签名 。
%登陆实验服务器，安装使用node.js中的express模块建议一个web服务器并指定端口；安装Nginx并把所有实验的证书移动到服务器；编辑Nginx的服务器并为每个证书配置一个子域名并反向代理到web服务器端口；启动Nginx监听80和443端口。
%分别使用4种不同内核的浏览器，以HTTPS的方式访问每一个实验对应的域名，浏览器会在握手完成前发送访问域名的SNI信息，服务器端的Nginx会根据浏览器发来的SNI信息分发相对应子域名的证书；浏览器收到证书，和服务器握手完成，建立HTTPS连接；浏览器根据证书和安全设置的不同情况会有不同的反应，对实验结果进行记录。



%Our goal is to build a test harness that is able to determine whether a web browser reports HTTPS security warning for a variety of different kinds of HTTPS errors.

%we generate our own root certificate and install it so that the web browser trusts it.
%    This allows us to then generate and sign intermediate and leaf certificates as we wish.
%We implement out test as follows: for each test,
%    (1)generates a unique DNS name,
%    (2) uses OpenSSL to generate a test certificate that are syntactically well-formed but may violate one of the certificate constraints and internal dependencies that a valid certificate must satisfy.
%    (3)generate an Nginx server configuration for the test.
%Thus, each test has a dedicated DNS name and Nginx instance to serve the certificate chain.
%    We create a web page to present the browser certificate validation results.
 %   Thus, We can record whether the HTTPS security warning is triggered by such a combination of a test certificate and a HTTPS implementation.

The evaluated browsers are Chrome v67.0.3396.99,
 Firefox v62.0, Edge v42.17134.1.0, and IE v11.0.9600.17031 on Windows 10.
The results are summarized in Table I.
A, B, and C represent a warning of low-risk, medium-risk, high-risk, respectively.
D represent a fatal warning.
In order to find the browser behaviors on specified HTTPS errors,
   in each line of this table,
    we induce only one error in the certificate chains or HTTP headers,
    unless otherwise stated.
% A, B, C, and D represent low-risk, medium-risk, high-risk, and fatal warnings, respectively.

\begin{table*}[htbp]
\centering
\caption{Browser Behaviors on HTTPS Errors}
\begin{tabular}{p{2.55cm}|l|cccc}
\toprule
\multicolumn{2}{c|}{\multirow{2}{*}{HTTPS Errors}} & \multicolumn{4}{l}{Browser Security Warning} \\ \cline{3-6}
\multicolumn{2}{c|}{} & Chrome & Firefox & Edge & IE \\ \midrule[1pt]
\multirow{12}{*}{\begin{tabular}[c]{@{}c@{}}Certificate Verification\\of Basic Fields\end{tabular}}
 & Untrusted root CA certificate & B & B & B & B \\
% & Untrusted self-signed server certificate & B & \textcolor[rgb]{1.00,0.00,0.00}{B[xx]} & B & B \\     % 这里应该有点什么专门的解释说明
 & Incomplete certificate chain & B & B & B & B \\
 & Expired server certificate & B & B & B & B \\ \cline{2-6}
 & Revoked server certificate (via OCSP) & Secure & C & C & C \\
 & Revoked server certificate (via CRL) & Secure & Secure & C & C \\
 & Revoked server certificate (via CRLSet) & C & Secure & Secure & Secure \\ \cline{2-6}
 & Weak key (512-bit RSA key) & B & B & B & C \\
 & Weak key (1024-bit RSA key) & Secure & Secure & Secure & Secure \\
 & Weak key (160-bit ECC key) & D & D & D & D \\ \cline{2-6}
 & Weak hash algorithm (SHA-1) & B & B & Secure & Secure \\
 & Weak hash algorithm (MD5) & B & B & Secure & Secure \\ \midrule[1pt]
\multirow{17}{*}{\begin{tabular}[c]{@{}c@{}}Certificate Verification\\of Extensions\end{tabular}} & server certificate &  &  &  &  \\
 & ~~incorrect cA flag (``cA flag" = true), correct key usage & Secure & B & Secure & Secure \\
 & ~~incorrect cA flag (``cA flag" = true), incorrect key usage & Secure & C & Secure & Secure \\
 & CA certificate &  &  &  &  \\
 & ~~incorrect cA flag (``cA flag" = false) & C & B & C & C \\
 & ~~correct cA flag, incorrect PathLenConstraint & C & Secure & C & B \\ \cline{2-6}
 & server certificate &  &  &  &  \\
 & ~~no extended key usage, correct key usage & Secure & Secure & Secure & Secure \\
 & ~~no extended key usage, incorrect key usage & Secure & C & Secure & Secure \\
 & ~~no extended key usage, no key usage & Secure & Secure & Secure & Secure \\
 & ~~correct extended key usage, correct key usage & Secure & Secure & Secure & Secure \\
 & ~~correct extended key usage, incorrect key usage & Secure & Secure & Secure & Secure \\
 & ~~correct extended key usaget, no key usage & Secure & Secure & Secure & Secure \\
 & ~~incorrect extended key usage, correct key usage & C & C & C & C \\
 & ~~incorrect extendedKeyUsage, incorrect key usage & C & C & C & C \\
 & ~~incorrect extendedKeyUsage, no key usage & C & C & C & C \\
 & CA certificate &  &  &  &  \\
 & ~~incorrect key usage & C & C & C & C \\ \midrule[1pt]
\multirow{11}{*}{\begin{tabular}[c]{@{}c@{}}Name Validation\end{tabular}}
 & \textcolor[rgb]{1.00,0.00,0.00}{domain name complete mismatch} & B & B & B & B \\  % 这个也是B，与WWW mismatch都一样，不合适！应该讨论
 & www mismatch & B & B & B & B \\
 & out-of-wildcard-scope subdomain error & B & B & B & B \\ \cline{2-6}
 & SAN and CN &  &  &  &  \\
 & ~~correct SAN, no CN & Secure & Secure & Secure & Secure \\
 & ~~correct SAN, \textcolor[rgb]{1.00,0.00,0.00}{incorrect CN} & Secure & Secure & Secure & Secure \\ % incorrect的具体做法是什么？
 & ~~incorrect SAN, no CN & B & B & B & B \\
 & ~~incorrect SAN, correct CN & B & B & B & B \\
 & ~~incorrect SAN, incorrect CN & B & B & B & B \\
 & ~~no SAN, incorrect CN & B & B & B & B \\
 & ~~no SAN, correct CN & B & Secure & Secure & Secure \\ \midrule[1pt]
\multirow{13}{*}{\begin{tabular}[c]{@{}c@{}}HTTPS Security\\Enhancement\end{tabular}}
 & HPKP: \textcolor[rgb]{1.00,0.00,0.00}{private store} &  &  &  &  \\      % 什么是private/public store？要有合适的解释。
 & ~~first visit: incorrect HPKP header, second visit: correct/incorrect/no HPKP header & Secure & Secure & Secure & Secure \\
 & ~~first visit: correct HPKP header, second visit: incorrect/no HPKP header & Secure & Secure & Secure & Secure \\
 & HPKP: public store &  &  &  &  \\
 & ~~first visit: incorrect HPKP header, second visit: correct/incorrect/no HPKP header & Secure & Secure & Secure & Secure \\
 & ~~first visit: correct HPKP header correct, second visit: incorrect/no HPKP header & C & C & Secure & Secure \\ \cline{2-6}
 & HSTS: not preload list &  &  &  &  \\
 &~~some resouces over plain HTTP & A & A & A & A \\
 & ~~first visit: correct HSTS header, second visit: HTTPS error &C & C & C &C \\
 & HSTS: preload list &  &  &  &  \\
 & ~~some resouces over plain HTTP & A & A & A & A \\
 & ~~first visit: HTTPS errors & C &C & C & C \\ \bottomrule
\end{tabular}

  \label{tab:addlabel}%
  \vspace{6pt}

\leftline{``Secure" means that the browsers don't display any warnings.}
%\leftline{``B-\textgreater{}C" means that the policy will raise the original B-level warning to Level C.}

\end{table*}%




\subsection{Certificate Verification Errors of Basic Fields}
In these tests,
    the certificate extensions of Basic Constraints, Key Usage, Extended Key Usage and SAN,
        are correctly set.
The name in commonName also appears to be correct.

\noindent\textbf{Untrusted root CA certificate.}
We use OpenSSL to generate a certificate chain, %(whose cA flag is true, pathLenConstraint is null, key usage is keyCertSign),
 %   then use the root certificate to issue a valid server certificate (both CN and SAN of the server certificate contain the server's domain name, the key usage is keyEncipherment, extended key usage is serverAuth, and cA flag is false).
 and the root CA is not trusted by browsers.
%When visiting the website, We will receive the server certificate and a Level-B medium-risk warning with the error hint ``NET::ERR\_CERT\_AUTHORITY\_INVALID''.
All browsers show a Level-B warning on this error.
This warning is eliminated
 as we install the self-signed CA certificate in the root CA certificate store.
Chrome, Edge and IE rely on the Windows root CA certificate store,
     and Firefox uses its own NSS certificate store.



%%%%%%%%%%%%\textbf{Untrusted self-signed server certificate.}
%Basic Constraint = cA flag + pathLenConstraint
%%%%%%%We use OpenSSL to generate a self-signed server certificate
%%%%%%%    (who does not have Basic Constraint field, key usage is keyEncipherment and keyCertSign, extended key usage is serverAuth, and both CN and SAN of the self-signed server certificate contain the server's domain name).
%% 应该说明出：与root CA之间的区分！root CA也有自己的安装过程？
%%%%%When we visit sites deploying self-signed server certificates, all four browsers display Level-B medium-risk warnings.
%%%%%After installing the self-signed certificates into the OS root store, Chrome, Edge, and IE consider it secure.
%%%%%%%%%The NSS root certificate store in Firefox does not accept self-signed server certificates, We need to avoid this warning by adding exception.

%chrome显示的警告是NET::ERR_CERT_AUTHORITY_INVALID，Firefox显示的警告是MOZILLA_PKIX_ERROR_SELF_SIGNED_CERT
%    After installing the self-signed certificates into the OS root store, Chrome, Edge, and IE consider it secure, but Firefox still displays a B-level (Medium-risk) warning.
%   Firefox has its own trust certificate store.
 %  First, click the ``Advanced" button on the warning page.
  % Second, click the ``Add Exception" button and confirm the domain name we added.
   %Third, click the ``Confirm Security Exception " button.
   %After all the steps have been completed, Firefox considers it secure.
%
%\textbf{Incomplete Certificate Chain.}
%\textbf{Expired Certificate.}

\noindent\textbf{Incomplete certificate chain, and expired server certificate.}
All browsers show Level-B warnings on an incomplete certificate chain, or expired server certificate.




\noindent\textbf{Revoked server certificate.}
In the certificate chain,
the server certificate is revoked and all CA certificates are not revoked.
(\emph{a}) OCSP. The server certificate is signed and revoked by Let's Encrypt.
    Let's Encrypt distributes the revocation status through OCSP.
Firefox, Edge, and IE show Level-C warnings,
    but Chrome considers it as secure.
(\emph{b}) CRL. When the server certificate is revoked through CRL,
 Chrome and Firefox consider it as secure, while Edge and IE show Level-C warnings \cite{liu2015end}.
(\emph{c}) CRLset. When the revoked server certificate is included in CRLset,
 Chrome shows a Level-C warning.

%\textcolor[rgb]{1.00,0.00,0.00}{    If a revoked certificate only contains available CRL field,
%        Chrome and Firefox consider it secure,
 %           but Edge and IE display C-level (High-risk) warnings.}
%%%%%%% 没有明确说清楚，是不是已经被撤销了？我们自己建立了OCSP服务器？CRLSet中，是怎么处理的？
%    If a revoked certificate only contains available OCSP field,
 %       Chrome considers it secure, but Firefox,
  %          Edge and IE display C-level (High-risk) warnings.
   % If a revoked certificate is only included in Chrome CRLset,
    %    Chrome displays a C-level (High-risk) warning,
     %       but Firefox, Edge and IE consider it secure.

%\textbf{Weak Signature Algorithm.}
\textbf{Weak key.}
%In this weak key paragraph, all server certificates are signed by SHA-256 with RSA Encryption.
 When receiving a server certificate binding a 512-bit RSA key pair,
    Chrome, Firefox, and Edge show Level-B warnings,
            while a C-level warning is shown in IE.
On a server certificate binding a 1024-bit RSA key pair,
    all browsers consider it as secure.
On a server certificate binding a 160-bit ECC key pair,
    all browsers show Level-D fatal warnings.

%\textbf{Weak Digest Algorithm.}
\textbf{Weak hash algorithm.}
%In this weak hash algorithm paragraph, all server certificates are signed by RSA and the public key of server certificates are 1024-bit RSA key.
    When receiving a server certificate signed by SHA-1 or MD5,
        Chrome and Firefox display Level-B warnings,
            but Edge and IE consider it as secure.
\subsection{Certificate Verification Errors of Extensions}
\textbf{Basic constraints extension.}
In this basic constraints extension paragraph,
    the certificate chain contains three certificates: self-signed root CA certificate, intermediate certificate, and server certificate.
    The self-signed root CA certificate has been added to the browsers' trust root store as required.

If a server certificate whose cA flag is incorrect (cA flag is true), but other fields is correct (key usage is key Enpherment, extended key usage is serverAuth),
    Chrome, Edge, and IE consider it secure,
    and Firefox displays a Level-B medium-risk warning.

If a server certificate whose cA flag is incorrect (cA flag is true), and other fields is incorrect (key usage is keyCertSign, does not have extended key usage field),
    Chrome, Edge, and IE consider it secure,
    and Firefox displays a Level-C high-risk warning.

If a server certificate is signed by a certificate whose cA flag is incorrect (cA flag is false), but other fields is correct (key usage is keyCertSign, does not have extended key usage field),
     Chrome, Edge, and IE display Level-C high-risk warnings,
     and Firefox displays a Level-B medium-risk warning.
     %\textcolor[rgb]{1.00,0.00,0.00}{Firefox's NSS root store does not accept a certificate whose CA flag is false, so we does test the Firefox for this HTTPS error.}  % 应该使用多级证书；root CA的flag正确，中间CA的flag错误，第三级证书！

If a server certificate is signed by a certificate whose cA flag is incorrect (cA flag is false), and other fields is incorrect (key usage is key Enpherment, extended key usage is serverAuth, both CN and SAN contain some domain names).
     Chrome, Edge, and IE display Level-C high-risk warnings,
     and Firefox displays a Level-B medium-risk warning.
That is, if a server certificate whose cA flag is set to ``true", it can issue certificates for any domain names and may launch man-in-the-middle attacks successfully, because Firefox simply displays a bypassable Level-B medium-risk warning.

If a server certificate is signed by a CA certificate that has a correct cA flag (cA flag is true)
    but does not conform to PathLenConstraint (the PathLenConstraint of self-signed root CA certificate is 0),
    Chrome and Edge display Level-C high-risk warnings,
    Firefox consider it secure, and IE displays a Level-B medium-risk warning.


\textbf{Key Usage and Extended Key Usage.}
    We didn't designate key usage and the extend key usage as critical or non-critical.
    If a server certificate has extended key usage field including serverAuth, no matter what the key usage is,
        all the four browsers consider it secure.
    If a server certificates has extended key usage field not including serverAuth, no matter what the key usage is,
        all the four browsers display Level-C high-risk warnings.
    If a server certificates does not have extended key usage field, and its key usage field is correct or does not have key usage field,
        all the four browsers consider it secure.
    If a CA certificate has incorrect key usage field,
        all the four browsers display Level-C high-risk warnings.

\subsection{Name Validation Errors}
    For domain name complete mismatch, www mismatch, and out-of-wildcard scope subdomain error,
    all four browsers display Level-B medium-risk warnings.

Next, SAN or CN incorrect means domain name complete mismatch.
    For correct SAN, no matter what the CN is, all the four browsers consider it secure.
    For incorrect SAN, no matter what the CN is, all the four browsers display Level-B medium-risk warnings.
    If the server certificate does not have SAN field, and the CN field is incorrect, all the four browsers display Level-B medium-risk warnings.
    If the server certificate does not have SAN field, and the CN field is incorrect,
    Chrome displays a Level-B medium-risk warning,
            but Firefox, Edge, and IE consider it secure.

\subsection{HTTPS Security-Enhancement Errors}
\textbf{HPKP.}
``private store" means that the root certificate of the certificate chain is installed  manually by the user to the browsers' trust root store.
    In this paragraph, the root certificate is generated by OpenSSL.
``public store" means that root certificate of the certificate chain is trusted by browsers.
    In this paragraph, the root certificate is from Let's Encrypt.

Edge and IE don't support HPKP, so they don't display any warnings on HPKP errors.
    Chrome and Firefox have the same behaviors on HPKP validation.

%    Next, let's look at the warning behaviors of Chrome and Firefox.
%If the root certificate of the certificate chain is installed manually by the user, no HPKP errors will be warned.
If the root certificate is from private store, no HPKP errors will be warned.
    If the root certificate of the certificate chain is from public store, there are two scenarios.
        (1)We received an incorrect HPKP header when we visit the website for the first time, such as nonnumeric max-age, pin-sha256 mismatch,
        then when we visit the website for the second time, no HPKP errors will be warned.
        (2)We received a correct HPKP header when we visit the website for the first time,
        then when we visit the website for the second time,
            if no certificate in the certificate chain matches the first time pinned certificates,
        a HPKP error will be warned, Chrome and Firefox will display Level-C high-risk warnings.


%correct HPKP header的意思是说, HPKP header遵循RFC7469的规定：HPKP header中至少有两个pin-sha256，一个在证书链上，一个不在证书链上,max-age的值是一个正数


%HPKP语法Public-Key-Pins: pin-sha256="base64=="; max-age=expireTime [; includeSubDomains][; report-uri="reportURI"]
%Chrome会对public store中的证书进行HPKP 检查
%①Pin header = 1个证书链中的证书
%不缓存
%②Pin header = 1个不在证书链中的证书
%不缓存
%③Pin header = 2个都在证书链中的证书
%不缓存
%④第一次访问时pin header = 证书链中的Cert A &非证书链中的 backup cert，
%把证书A发送给浏览器；（A可以是中间CA，可以是末端证书）
%第二次访问时pin header = 证书链中的Cert A &非证书链中的 backup cert，
%把backup certificate发送给浏览器
%会缓存，不报错
%⑤Max-age设置为0、负数、非数值
%不缓存
%⑥第一次访问时pin header = 证书链中的Cert A &非证书链中的 backup cert，
%把证书A发送给浏览器；（A可以是中间CA，可以是末端证书）；
%第二次访问时pin header = backup cert & 非证书链中的C，
%把backup certificate发送给浏览器；
%第三次访问时，不发送pin header，把Cert A发送给browser
%第三次访问时报错，缓存里是backup & C
%⑦第一次Pin header = A & B，发送A到浏览器
%第二次不发送pin header，发送A到浏览器
%不报错，缓存还在
%⑧第一次pin header = 证书链中的Cert A &非证书链中的 backup cert
%发送A给浏览器；
%第二次pin header = Cert A & C，发送C给浏览器
%会报错，缓存里是第一次的pin值
%总结：只有第一次pin对，第二次pin错的时候才会报错，其他时候都不报错



 \textbf{HSTS.}
 HSTS is a trust-on-first-use policy, but HSTS has a preload list in the browsers.
 Whenever visiting the domain name in the preload list,
    the browser will only use HTTPS to initiate the connection.
 This list is maintained by Google Chromium and is used by mainstream browsers like FireFox, Edge and IE.


    Whenever you visit a website in the HSTS preload list, % 什么是preload list？应该有解释。现在的结果，看起来，莫名其妙。
    if the website has HTTPS error including incomplete certificate chain, expired certificates, or any other Level-B medium-risk HTTPS errors mentioned in this paper,
    all the four browsers will display Level-C high-risk warnings.
        %all the four browsers display C-level (High-Risk) warnings on B-level (Medium-Risk) HTTPS errors,
    All the four browsers display Level-A low-risk warnings on websites that transmit some resources over plain HTTP.

    When we visit a website not in the HSTS preload list,
        if we received an correct HSTS header when we visit the website for the first time,
        then when we visit the website for the second time encountering Level-B medium-risk HTTPS errors mentioned in this paper,
        all the four browsers display Level-C high-risk warnings.
        All the four browsers display Level-A low-risk warnings on websites that transmit some resources over plain HTTP.

%The site's certificate must first be trusted by the browser, including server authentication and certificate/certificate chain verification. We first pin the sha256 value of the intermediate CA and any other sha256 value into the header, and the browser will cache the two sha256 values ??and verify them in the next access within the cache effective time. If the two sha256 values ??of the pin are in the same certificate chain, they will not be cached and will not prompt any errors.

%If the next time the certificate issued by the site is valid and the certificate is in the pin list, the HPKP cache will be refreshed, including the SHA-256 value of the pin and the cache validity period, whichever comes first. If the intermediate CA of a certificate chain that a webmaster plans to replace is not in the current pin, you should keep using the original certificate or the alternate certificate and change the value of the other pin until the longest cache time, you can safely delete the old certificate's Pin.

%In a site with HPKP cache and in effect, if the certificate received when accessing the site is a certificate in the public certificate store, and the certificate chain is not in the pin, it will be reported by the browser, but can be ignored. If the visited site is in a private certificate store, ie a self-signed certificate chain, no errors will be reported even if the certificate does not comply with the HPKP policy, and the HPKP settings cache will not be updated.

%The cache of the HPKP policy has no relationship with the storage area where the certificate is located. If the certificate is legal in the browser and does not conflict with the pin in the cache, the sha256 value of the self-signed certificate chain is also stored in the pin of the HPKP policy.

%When the site has the HSTS header set and is not in the preloaded list, the first visit to the site does not force https access. When the local browser has the HSTS setting cache, the browser will make a jump inside the browser when accessing the http site without initiating an HTTP network request.

%\begin{figure}[htbp]
%\centerline{\includegraphics{Figure/fig5.png}}
%\caption{Network requests to access a site with HSTS.}
%\label{fig}
%\end{figure}

%The cache obtained by the browser through the HSTS response header is stored in the dynamic HSTS, and the site in the preloaded list is in the static storage area, which cannot be modified after the browser is compiled. However, the HSTS policy is stored in two areas and has no effect on the validity of the settings.

%The HSTS policy only takes effect in the risk alert that the browser can skip. It will block the option to ignore the error, and the browser will also prompt "Cannot continue browsing due to the HSTS policy." For low-risk prompts (Level A), the browser can still access the site normally, and there will be an exclamation point prompt, which is no different from the prompt without the HSTS policy. Naturally, there is no change to the risk alert (Level C) that could not be skipped.

