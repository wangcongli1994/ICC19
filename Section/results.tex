\section{Browser Behaviors on HTTPS Errors}
%There are many community standards for certificate validation,
%    for example,
%    RFC 5246, RFC 6125, and RFC 5280.
%    The certificate validation in browser
%    is more than a  literal replication of Internet standards protocols.
%    It needs to balance security, standards, and user experiences.
\subsection{Goal and Methodology}
We attempt to analyze the browser security warnings
    of various HTTPS errors.
We register a domain name and
    establish the website for it by Nginx.
We induce different HTTPS errors
    by
    (\emph{a}) invalid or defective certificate chains in TLS negotiations,
    (\emph{b}) mismatched public keys (or certificates) after HPKP pins the public keys in browsers,
    and (\emph{c}) HTTP connections after the HSTS policy is activated in browsers.
Then, the evaluated browsers visit  the website one by one,
    and we record the browser behaviors.
We generate key pairs and certificates of CAs and servers by OpenSSL,
    and TLS 1.2 is adopted in the HTTPS connections.

%we register a domain name and resolve many subdomains to our web server, and
%    each subdomain has a certificate that violate one of the certificate constraints.
%    We use browsers to visit these domains and observe the browsers' behavior.
%All connections to the web server is encrypted and authenticated using TLS 1.2.


%从域名商购得域名，并把该域名的所有子域名解析到我的服务器IP。根据实验安排首先生成一个自签名的根CA，安装根CA到系统和浏览器种，并使用该根CA对每一个实验的证书进行签名。对于每个证书：1.生成一个私钥 2.根据实验内容设置一个OpenSSL的配置文件 3.生成证书请求 4.使用OpenSSL签名 。
%登陆实验服务器，安装使用node.js中的express模块建议一个web服务器并指定端口；安装Nginx并把所有实验的证书移动到服务器；编辑Nginx的服务器并为每个证书配置一个子域名并反向代理到web服务器端口；启动Nginx监听80和443端口。
%分别使用4种不同内核的浏览器，以HTTPS的方式访问每一个实验对应的域名，浏览器会在握手完成前发送访问域名的SNI信息，服务器端的Nginx会根据浏览器发来的SNI信息分发相对应子域名的证书；浏览器收到证书，和服务器握手完成，建立HTTPS连接；浏览器根据证书和安全设置的不同情况会有不同的反应，对实验结果进行记录。



%Our goal is to build a test harness that is able to determine whether a web browser reports HTTPS security warning for a variety of different kinds of HTTPS errors.

%we generate our own root certificate and install it so that the web browser trusts it.
%    This allows us to then generate and sign intermediate and leaf certificates as we wish.
%We implement out test as follows: for each test,
%    (1)generates a unique DNS name,
%    (2) uses OpenSSL to generate a test certificate that are syntactically well-formed but may violate one of the certificate constraints and internal dependencies that a valid certificate must satisfy.
%    (3)generate an Nginx server configuration for the test.
%Thus, each test has a dedicated DNS name and Nginx instance to serve the certificate chain.
%    We create a web page to present the browser certificate validation results.
 %   Thus, We can record whether the HTTPS security warning is triggered by such a combination of a test certificate and a HTTPS implementation.

The evaluated browsers are Chrome v67.0.3396.99,
 Firefox v62.0, Edge v42.17134.1.0, and IE v11.0.9600.17031 on Windows 10.
The results are summarized in Table I.
A, B, C, and D represent low-risk, medium-risk, high-risk, and fatal warnings, respectively.

\begin{table*}[htbp]
\centering
\caption{Browser Behaviors on HTTPS Errors}
\begin{tabular}{p{2.55cm}|l|cccc}
\toprule
\multicolumn{2}{c|}{\multirow{2}{*}{HTTPS Errors}} & \multicolumn{4}{l}{Browser Security Warning} \\ \cline{3-6}
\multicolumn{2}{c|}{} & Chrome & Firefox & Edge & IE \\ \midrule[1pt]
\multirow{12}{*}{\begin{tabular}[c]{@{}c@{}}Certificate Verification\\of Basic Fields\end{tabular}}
 & Untrusted root CA certificate & B & B & B & B \\
 & Untrusted self-signed server certificate & B & \textcolor[rgb]{1.00,0.00,0.00}{B[xx]} & B & B \\     % 这里应该有点什么专门的解释说明
 & Incomplete certificate chain & B & B & B & B \\
 & Expired server certificate & B & B & B & B \\ \cline{2-6}
 & Revoked server certificate (via CRL) & Secure & Secure & C & C \\
 & Revoked server certificate (via OCSP) & Secure & C & C & C \\
 & Revoked server certificate (via CRLSet) & C & Secure & Secure & Secure \\ \cline{2-6}
 & Weak signature algorithm (RSA-512) & B & B & B & C \\
 & Weak signature algorithm (RSA-1024) & Secure & Secure & Secure & Secure \\
 & Weak signature algorithm (ECC-160) & D & D & D & D \\ \cline{2-6}
 & Weak hash algorithm (SHA-1) & B & B & Secure & Secure \\
 & Weak hash algorithm (MD5) & B & B & Secure & Secure \\ \midrule[1pt]
\multirow{17}{*}{\begin{tabular}[c]{@{}c@{}}Certificate Verification\\of Extensions\end{tabular}} & server certificate &  &  &  &  \\
 & ~~incorrect CA falg (``CA flag" = true) & Secure & B & Secure & Secure \\
 & CA certificate &  &  &  &  \\
 & ~~incorrect CA falg (``CA flag" = false) & C & B & C & C \\
 & ~~correct CA flag, incorrect PathLenConstraint & C & Secure & C & B \\ \cline{2-6}
 & server certificate &  &  &  &  \\
 & ~~no extended key usage, correct key usage & Secure & Secure & Secure & Secure \\
 & ~~no extended key usage, incorrect key usage & Secure & C & Secure & Secure \\
 & ~~no extended key usage, no key usage & Secure & Secure & Secure & Secure \\
 & ~~correct extended key usage, correct key usage & Secure & Secure & Secure & Secure \\
 & ~~correct extended key usage, incorrect key usage & Secure & Secure & Secure & Secure \\
 & ~~correct extended key usaget, no key usage & Secure & Secure & Secure & Secure \\
 & ~~incorrect extended key usage, correct key usage & C & C & C & C \\
 & ~~incorrect extendedKeyUsage, incorrect key usage & C & C & C & C \\
 & ~~incorrect extendedKeyUsage, no key usage & C & C & C & C \\
 & CA certificate &  &  &  &  \\
 & ~~incorrect key usage & C & C & C & C \\ \midrule[1pt]
\multirow{11}{*}{\begin{tabular}[c]{@{}c@{}}Name Validation\end{tabular}}
 & \textcolor[rgb]{1.00,0.00,0.00}{domain name complete mismatch} & B & B & B & B \\  % 这个也是B，与WWW mismatch都一样，不合适！应该讨论
 & www mismatch & B & B & B & B \\
 & out-of-wildcard-scope subdomain error & B & B & B & B \\ \cline{2-6}
 & SAN and CN &  &  &  &  \\
 & ~~correct SAN, no CN & Secure & Secure & Secure & Secure \\
 & ~~correct SAN, \textcolor[rgb]{1.00,0.00,0.00}{incorrect CN} & Secure & Secure & Secure & Secure \\ % incorrect的具体做法是什么？
 & ~~incorrect SAN, no CN & B & B & B & B \\
 & ~~incorrect SAN, correct CN & B & B & B & B \\
 & ~~incorrect SAN, incorrect CN & B & B & B & B \\
 & ~~no SAN, incorrect CN & B & B & B & B \\
 & ~~no SAN, correct CN & B & Secure & Secure & Secure \\ \midrule[1pt]
\multirow{13}{*}{\begin{tabular}[c]{@{}c@{}}HTTPS Security\\Enhancement\end{tabular}}
 & HPKP: \textcolor[rgb]{1.00,0.00,0.00}{private store} &  &  &  &  \\      % 什么是private/public store？要有合适的解释。
 & ~~first visit: incorrect HPKP header, second visit: correct/incorrect/no HPKP header & Secure & Secure & Secure & Secure \\
 & ~~first visit: correct HPKP header, second visit: incorrect/no HPKP header & Secure & Secure & Secure & Secure \\
 & HPKP: public store &  &  &  &  \\
 & ~~first visit: incorrect HPKP header, second visit: correct/incorrect/no HPKP header & Secure & Secure & Secure & Secure \\
 & ~~first visit: correct HPKP header correct, second visit: incorrect/no HPKP header & C & C & Secure & Secure \\ \cline{2-6}
 & HSTS: not preload list &  &  &  &  \\
 & ~~first visit: correct HSTS header, second visit: HTTPS error & B-\textgreater{}C & B-\textgreater{}C & B-\textgreater{}C & B-\textgreater{}C \\
 & ~~first visit: incorrect HSTS header, second visit: correct/incorrect/no HSTS header & Secure & Secure & Secure & Secure \\
 & HSTS: preload list &  &  &  &  \\
 & ~~some resouces over plain HTTP & A & A & A & A \\
 & ~~first visit: HTTPS errors & B-\textgreater{}C & B-\textgreater{}C & B-\textgreater{}C & B-\textgreater{}C \\ \bottomrule
\end{tabular}

  \label{tab:addlabel}%
  \vspace{6pt}

\leftline{A, B, and C respectively represent Risk Level A, Risk Level B and Risk Level C of browser warnings.}
\leftline{``Secure" means that the browsers don't display any warnings.}
\leftline{``B-\textgreater{}C" means that the policy will raise the original B-level warning to Level C.}

\end{table*}%


%\textbf{Certificate has no partial fields.}
%    A certificate may not have a Common Name or SAN field. In OpenSSL, certificates that do not fill in the above fields can also be generated and be signed.
 %   For the Common Name, some very old browsers may not support certificates without Common Name. % The Chrome browser does not support certificates without a SAN field.

\subsection{Certificate Verification Errors of Basic Fields}

\textcolor[rgb]{1.00,0.00,0.00}{\textbf{Untrusted self-signed server certificate.}}
%% 应该说明出：与root CA之间的区分！root CA也有自己的安装过程？
    When we visit sites deploying self-signed server certificates, all four browsers display B-level (Medium-risk) warnings.
    After installing the self-signed certificates into the OS root store, Chrome, Edge, and IE consider it secure, but Firefox still displays a B-level (Medium-risk) warning.
   Firefox has its own trust certificate store.
   First, click the ``Advanced" button on the warning page.
   Second, click the ``Add Exception" button and confirm the domain name we added.
   Third, click the ``Confirm Security Wxception " button.
   After all the steps have been completed, Firefox considers it secure.
    %However, The NSS store in Firefox does not accept self-signed certificates, and Firefox always displays B-level (Medium-risk) warnings for self-signed sever certificates.
%
%\textbf{Untrusted Root CA Certificate.}
%\textbf{Incomplete Certificate Chain.}
%\textbf{Expired Certificate.}
Other errors including untrusted root CA certificate, incomplete certificate chain, and expired certificate,
        all browsers show Level-B medium-risk warnings.

\textbf{Revoked certificate.}
\textcolor[rgb]{1.00,0.00,0.00}{    If a revoke certificate only contains available CRL field,
        Chrome and Firefox consider it secure,
            but Edge and IE display C-level (High-risk) warnings.}
%%%%%%% 没有明确说清楚，是不是已经被撤销了？我们自己建立了OCSP服务器？CRLSet中，是怎么处理的？
    If a revoke certificate only contains available OCSP field,
        Chrome considers it secure, but Firefox,
            Edge and IE display C-level (High-risk) warnings.
    If a revoke certificate is only included in Chrome CRLset,
        Chrome displays a C-level (High-risk) warning,
            but Firefox, Edge and IE consider it secure.

%\textbf{Weak Signature Algorithm.}
\textbf{Weak signature algorithm.}
    For RSA-512,
        Chrome, Firefox, and Edge display B-level (Medium-risk) warnings,
            but IE display a C-level (High-risk) warning.
    For RSA 1024,
        all four browsers consider it secure.
    For ECC 160,
        all four browsers display D-level (Fatal) warnings.

%\textbf{Weak Digest Algorithm.}
\textbf{Weak hash algorithm.}
    For SHA-1 and MD5,
        Chrome and Firefox display B-level (Medium-risk) warnings,
            but Edge and IE consider them secure.

\subsection{Certificate Verification Errors of Extensions:}

\textbf{Basic Constraints Extension.}
    If a server certificate is signed by a CA certificate that has a correct CA flag but does not conform to PathLenConstraint,
    Chrome and Edge display C-level (High-risk) warnings,
    Firefox consider it secure, and IE displays a B-level (Medium-risk) warning.

    If a server certificate whose CA flag is true,
    Chrome, Edge, and IE consider it secure,
    and Firefox displays a B-level (Medium-risk) warning.

    If a server certificate is signed by a certificate whose CA flag is false,
     Chrome, Edge, and IE display C-level (High-risk) warnings.
     \textcolor[rgb]{1.00,0.00,0.00}{Firefox's NSS root store does not accept a certificate whose CA flag is false, so we does test the Firefox for this HTTPS error.}  % 应该使用多级证书；root CA的flag正确，中间CA的flag错误，第三级证书！

\textbf{Key Usage and Extended Key Usage.}
    If a server certificate has Extended key usage field including serverAuth, no matter what the key usage is,
        all the four browsers consider it secure.
    If a server certificates has Extended key usage field not including serverAuth, no matter what the key usage is,
        all the four browsers display C-level (High-risk) warnings.
    If a server certificates does not have Extended key usage field, and its key usage field is correct or does not have key usage field,
        all the four browsers consider it secure.
    If a CA certificate has incorrect key usage field,
        all the four browsers display C-level (High-risk) warnings.

\subsection{Name Validation Errors}
    For domain name complete mismatch, www mismatch, and out-of-wildcard scope subdomain error,
    all four browsers display B-level (Medium-risk) warnings.

    For correct SAN, no matter what the CN is, all the four browsers consider it secure.
    For incorrect SAN, no matter what the CN is, all the four browsers display B-level (Medium-risk) warnings.
    If the server certificate does not have SAN field, and the CN field is incorrect, all the four browsers display B-level (Medium-risk) warnings.
    If the server certificate does not have SAN field, and the CN field is incorrect,
    Chrome displays a B-level (Medium-risk) warning,
            but Firefox, Edge, and IE consider it secure.

\subsection{HTTPS Security-Enhancement Errors}
\textbf{HPKP}
Edge and IE don't support HPKP, so they don't display any warnings on HPKP errors.
    Chrome and Firefox have the same behaviors on HPKP validation.
%    Next, let's look at the warning behaviors of Chrome and Firefox.
If the root certificate of the certificate chain is installed manually by the user, no HPKP errors will be warned.
    If the root certificate of the certificate chain is preloaded in browser root store, there are two scenarios.
        (1)We received an incorrect HPKP header when we visit the website for the first time, such as nonnumeric max-age, pin-sha256 mismatch,
        then when we visit the website for the second time, no HPKP errors will be warned.
        (2)We received an correct HPKP header when we visit the website for the first time,
        then when we visit the website for the second time receiving incorrect HPKP header or not receiving any HPKP header, Chrome and Firefox will
        dispaly C-level (High-Risk) warnings.

 \textbf{HSTS}
    Whenever you visit a website in \textcolor[rgb]{1.00,0.00,0.00}{the HSTS preload list}, % 什么是preload list？应该有解释。现在的结果，看起来，莫名其妙。
        all the four browsers display C-level (High-Risk) warnings on B-level (Medium-Risk) HTTPS errors,
            and display A-level (Low-Risk) warnings on websites that transmit some resources over plain HTTP.

    When we visit a website not in the HSTS preload list,there are two scenarios.
        (1)We received an incorrect HSTS header when we visit the website for the first time,
        then when we visit the website for the second time, no HSTS errors will be warned.
        (2)We received an correct HSTS header when we visit the website for the first time,
        then when we visit the website for the second time encountering B-level (Medium-Risk) HTTPS errors,
        all the four browsers display C-level (High-Risk) warnings.

%The site's certificate must first be trusted by the browser, including server authentication and certificate/certificate chain verification. We first pin the sha256 value of the intermediate CA and any other sha256 value into the header, and the browser will cache the two sha256 values ??and verify them in the next access within the cache effective time. If the two sha256 values ??of the pin are in the same certificate chain, they will not be cached and will not prompt any errors.

%If the next time the certificate issued by the site is valid and the certificate is in the pin list, the HPKP cache will be refreshed, including the SHA-256 value of the pin and the cache validity period, whichever comes first. If the intermediate CA of a certificate chain that a webmaster plans to replace is not in the current pin, you should keep using the original certificate or the alternate certificate and change the value of the other pin until the longest cache time, you can safely delete the old certificate's Pin.

%In a site with HPKP cache and in effect, if the certificate received when accessing the site is a certificate in the public certificate store, and the certificate chain is not in the pin, it will be reported by the browser, but can be ignored. If the visited site is in a private certificate store, ie a self-signed certificate chain, no errors will be reported even if the certificate does not comply with the HPKP policy, and the HPKP settings cache will not be updated.

%The cache of the HPKP policy has no relationship with the storage area where the certificate is located. If the certificate is legal in the browser and does not conflict with the pin in the cache, the sha256 value of the self-signed certificate chain is also stored in the pin of the HPKP policy.

%When the site has the HSTS header set and is not in the preloaded list, the first visit to the site does not force https access. When the local browser has the HSTS setting cache, the browser will make a jump inside the browser when accessing the http site without initiating an HTTP network request.

%\begin{figure}[htbp]
%\centerline{\includegraphics{Figure/fig5.png}}
%\caption{Network requests to access a site with HSTS.}
%\label{fig}
%\end{figure}

%The cache obtained by the browser through the HSTS response header is stored in the dynamic HSTS, and the site in the preloaded list is in the static storage area, which cannot be modified after the browser is compiled. However, the HSTS policy is stored in two areas and has no effect on the validity of the settings.

%The HSTS policy only takes effect in the risk alert that the browser can skip. It will block the option to ignore the error, and the browser will also prompt "Cannot continue browsing due to the HSTS policy." For low-risk prompts (Level A), the browser can still access the site normally, and there will be an exclamation point prompt, which is no different from the prompt without the HSTS policy. Naturally, there is no change to the risk alert (Level C) that could not be skipped.

